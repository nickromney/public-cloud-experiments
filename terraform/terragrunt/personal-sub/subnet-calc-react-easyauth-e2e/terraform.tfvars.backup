# Subnet Calculator React Web App with Easy Auth E2E - Production Stack
# Deploys React SPA + FastAPI Function App backend with Azure AD authentication
# BOTH frontend AND backend use Easy Auth (end-to-end Azure AD, no JWT)

# Shared App Service Plan (used by both Web App and Function App)
service_plan = {
  name     = "plan-subnetcalc-dev-easyauth-e2e"
  os_type  = "Linux"
  sku_name = "EP1" # Elastic Premium plan
}

# Entra ID App Registration (created by Terraform, no client_id needed)
entra_id_app = {
  display_name     = "Subnet Calculator React E2E"
  sign_in_audience = "AzureADMyOrg"
  identifier_uris = [
    "api://subnet-calculator-react-easyauth-e2e"
  ]
}

web_app = {
  name            = "web-subnet-calc-react-easyauth-e2e"
  runtime_version = "22-lts"
  api_base_url    = "" # Auto-computed from function app
  always_on       = true
  startup_command = "node server.js"

  app_settings = {
    STACK_NAME = "Subnet Calculator React (Easy Auth E2E)"
    # Runtime configuration for Express server to inject into browser
    # Easy Auth for user login - no JWT credentials needed
    AUTH_METHOD = "easyauth"
    # API_BASE_URL will be set dynamically from function_app output
  }

  # Easy Auth with Managed Identity (no client secret required)
  # NOTE: client_id is automatically generated from entra_id_app module above
  # The Web App's managed identity authenticates to Entra ID - no secrets needed!
  # Redirect to login page for unauthenticated users (matches Static Web App behavior)
  easy_auth = {
    enabled              = true
    client_id            = "" # Auto-populated from entra_id_app module
    tenant_id            = "" # Optional: defaults to current tenant
    issuer               = "" # Optional: auto-generated if not specified
    use_managed_identity = true
    # KEY FIX: Empty allowed_audiences means accept tokens with web app's own client_id
    allowed_audiences      = []
    unauthenticated_action = "RedirectToLoginPage" # Redirect to login, matching Static Web App
    token_store_enabled    = true
    login_parameters       = {}
  }
}

function_app = {
  name                          = "func-subnet-calc-react-easyauth-e2e-api"
  runtime                       = "python"
  runtime_version               = "3.11"
  storage_account_name          = "stsubnetcalceasyauthe2e" # 24 chars (limit is 24)
  public_network_access_enabled = true

  cors_allowed_origins = [
    "https://web-subnet-calc-react-easyauth-e2e.azurewebsites.net",
    "http://localhost:5173",
    "http://localhost:4173"
  ]

  app_settings = {
    # NO JWT configuration - using Easy Auth for API authentication
    AzureWebJobsFeatureFlags = "EnableWorkerIndexing"
    # NOTE: Do NOT set ENABLE_ORYX_BUILD, WEBSITE_RUN_FROM_PACKAGE, or SCM_DO_BUILD_DURING_DEPLOYMENT
    # Let Azure automatically build dependencies during zip deployment (matches working func-subnet-calc-jwt)
  }

  # Managed Identity: use both System and User-Assigned
  # UAI is created automatically and gets storage permissions before Function App creation
  managed_identity = {
    enabled                    = true
    type                       = "SystemAssigned, UserAssigned"
    user_assigned_identity_ids = [] # Auto-populated with module-created UAI
  }

  # Easy Auth with Managed Identity for Function App
  # Function App validates the same Azure AD token from the Web App
  easy_auth = {
    enabled              = true
    client_id            = "" # Auto-populated from entra_id_app module
    tenant_id            = "" # Optional: defaults to current tenant
    issuer               = "" # Optional: auto-generated if not specified
    use_managed_identity = true
    allowed_audiences = [
      "api://subnet-calculator-react-easyauth-e2e"
    ]
    unauthenticated_action = "Return401" # Return 401 for APIs (don't redirect)
    token_store_enabled    = true
    login_parameters       = {}
  }
}
