apiVersion: batch/v1
kind: Job
metadata:
  name: signoz-bootstrap
  namespace: observability
  annotations:
    # This is a one-time bootstrap task (complete SigNoz setup + create the auth-proxy secret).
    # Model it as an Argo CD hook so it can be safely re-run and re-created (Jobs have immutable selectors).
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
    argocd.argoproj.io/sync-wave: "0"
  labels:
    app.kubernetes.io/name: signoz-bootstrap
    app.kubernetes.io/component: setup
spec:
  backoffLimit: 20
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/name: signoz-bootstrap
        app.kubernetes.io/component: setup
    spec:
      restartPolicy: OnFailure
      serviceAccountName: signoz-bootstrap
      containers:
        - name: bootstrap
          image: curlimages/curl:8.10.1
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -eu

              SIGNOZ_URL="http://signoz:8080"
              NAMESPACE="observability"
              SECRET_NAME="signoz-auth-proxy-credentials"

              K8S_API="https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}"
              SA_TOKEN_FILE="/var/run/secrets/kubernetes.io/serviceaccount/token"
              SA_CA_FILE="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
              SA_TOKEN="$(cat "${SA_TOKEN_FILE}")"
              SECRET_GET_URL="${K8S_API}/api/v1/namespaces/${NAMESPACE}/secrets/${SECRET_NAME}"
              SECRET_CREATE_URL="${K8S_API}/api/v1/namespaces/${NAMESPACE}/secrets"

              secret_exists() {
                curl -fsS \
                  --cacert "${SA_CA_FILE}" \
                  -H "Authorization: Bearer ${SA_TOKEN}" \
                  -o /tmp/secret.json \
                  "${SECRET_GET_URL}" >/dev/null 2>&1
              }

              echo "Waiting for SigNoz to become reachable..."
              i=0
              until curl -fsS -o /tmp/version.json "${SIGNOZ_URL}/api/v1/version" >/dev/null 2>&1; do
                i=$((i+1))
                if [ "$i" -ge 180 ]; then
                  echo "Timed out waiting for SigNoz"
                  exit 1
                fi
                sleep 2
              done

              if grep -q '"setupCompleted":true' /tmp/version.json; then
                if secret_exists; then
                  echo "SigNoz setup already completed (auth-proxy secret present)"
                  exit 0
                fi

                echo "SigNoz setup already completed but ${SECRET_NAME} is missing; cannot auto-configure auth proxy"
                exit 1
              fi

              echo "Completing SigNoz first-run setup..."

              # SigNoz requires setup completion even when auth is disabled; otherwise the UI forces /signup.
              # These credentials are only used to create the initial org/user and are not used for SSO.
              EMAIL="admin@local.dev"
              PASSWORD="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 16)Aa1!"
              PAYLOAD="$(printf '{"firstName":"Admin","email":"%s","organizationName":"Local","password":"%s","confirmPassword":"%s"}' "$EMAIL" "$PASSWORD" "$PASSWORD")"
              if ! curl -fsS -o /tmp/register.json \
                -H "content-type: application/json" \
                -d "$PAYLOAD" \
                "${SIGNOZ_URL}/api/v1/register" >/dev/null 2>&1; then
                echo "SigNoz register failed. Response:"
                cat /tmp/register.json || true
                exit 1
              fi

              if ! secret_exists; then
                echo "Creating ${SECRET_NAME} for signoz-auth-proxy..."

                SECRET_PAYLOAD="$(printf '{"apiVersion":"v1","kind":"Secret","metadata":{"name":"%s","namespace":"%s"},"type":"Opaque","stringData":{"SIGNOZ_URL":"%s","SIGNOZ_USER":"%s","SIGNOZ_PASSWORD":"%s"}}' "$SECRET_NAME" "$NAMESPACE" "$SIGNOZ_URL" "$EMAIL" "$PASSWORD")"

                if ! curl -fsS -o /tmp/secret-create.json \
                  --cacert "${SA_CA_FILE}" \
                  -H "Authorization: Bearer ${SA_TOKEN}" \
                  -H "content-type: application/json" \
                  -d "$SECRET_PAYLOAD" \
                  "${SECRET_CREATE_URL}" >/dev/null 2>&1; then
                  echo "Failed to create ${SECRET_NAME}"
                  cat /tmp/secret-create.json || true
                  exit 1
                fi
              fi

              curl -fsS -o /tmp/version2.json "${SIGNOZ_URL}/api/v1/version" >/dev/null 2>&1
              grep -q '"setupCompleted":true' /tmp/version2.json
