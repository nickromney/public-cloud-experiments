server {
  listen 80;

  # Docker's embedded DNS server. We need runtime DNS re-resolution because
  # container IPs can change on restarts (otherwise nginx caches the first lookup).
  resolver 127.0.0.11 valid=10s ipv6=off;

  # Route API requests to the sentiment API
  location /api/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    set $api_upstream "sentiment-api:8080";
    proxy_pass http://$api_upstream;
  }

  # Everything else goes to the protected frontend static server
  location / {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    set $frontend_upstream "sentiment-auth-frontend:80";
    proxy_pass http://$frontend_upstream;
  }
}
