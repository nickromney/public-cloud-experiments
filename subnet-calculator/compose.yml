# Compose configuration for Subnet Calculator - All Services
# Works with both podman-compose and docker compose
#
# Services:
#   - api-fastapi-azure-function: Azure Function backend (FastAPI via AsgiMiddleware)
#   - api-fastapi-container-app: Container App backend (FastAPI on Uvicorn)
#   - frontend-python-flask: Flask frontend (connects to Azure Function backend)
#   - frontend-html-static: Static HTML frontend (connects to Container App backend)
#   - frontend-python-flask-container-app: Flask frontend (connects to Container App backend)
#   - frontend-typescript-vite: TypeScript + Vite SPA (connects to Container App backend, no auth)
#   - frontend-typescript-vite-jwt: TypeScript + Vite SPA (connects to Azure Function backend, JWT auth)
#   - frontend-react: React SPA (connects to Container App backend, no auth)
#   - frontend-react-msal: React SPA (connects to Azure Function backend, MSAL local)
#   - keycloak: Keycloak identity provider (OAuth2/OIDC)
#   - api-fastapi-keycloak: Azure Function backend with Keycloak OIDC validation
#   - frontend-react-keycloak: React SPA with Keycloak OIDC authentication
#
# Usage:
#   podman-compose up                           # Start all services
#   podman-compose up api-fastapi-container-app frontend-html-static                  # local-stack-01
#   podman-compose up api-fastapi-container-app frontend-python-flask-container-app   # local-stack-02
#   podman-compose up api-fastapi-azure-function frontend-python-flask                # local-stack-03
#   podman-compose up api-fastapi-container-app frontend-typescript-vite              # local-stack-04
#   podman-compose up api-fastapi-azure-function frontend-typescript-vite-jwt         # local-stack-05
#   podman-compose up api-fastapi-container-app frontend-react                        # local-stack-06
#   podman-compose up api-fastapi-azure-function frontend-react-jwt                   # local-stack-07
#   podman-compose up api-fastapi-azure-function frontend-react-msal                  # local-stack-08 (requires MSAL config)
#   podman-compose up api-fastapi-azure-function frontend-react-server-jwt            # local-stack-09 (tests /runtime-config)
#   podman-compose up api-fastapi-azure-function frontend-react-proxy                 # local-stack-10 (Vite proxy -> Function App)
#   podman-compose up keycloak api-fastapi-keycloak frontend-react-keycloak           # local-stack-11 (Keycloak OAuth2/OIDC)
#
# Access:
#   local-stack-01 - Static HTML + Container App (no auth):
#     - Static Frontend: http://localhost:8001
#     - API docs: http://localhost:8090/api/v1/docs
#   local-stack-02 - Flask + Container App (no auth):
#     - Flask Frontend: http://localhost:8002
#     - API docs: http://localhost:8090/api/v1/docs
#   local-stack-03 - Flask + Azure Function (JWT):
#     - Flask Frontend: http://localhost:8000
#     - API docs: http://localhost:8080/api/v1/docs
#     - Login: demo / password123
#   local-stack-04 - TypeScript Vite + Container App (no auth):
#     - Vite SPA: http://localhost:8003
#     - API docs: http://localhost:8090/api/v1/docs
#   local-stack-05 - TypeScript Vite + Azure Function (JWT):
#     - Vite SPA: http://localhost:3001
#     - API docs: http://localhost:8080/api/v1/docs
#     - JWT: Automatic authentication (demo / password123)
#   local-stack-06 - React + Container App (no auth):
#     - React SPA: http://localhost:8004
#     - API docs: http://localhost:8090/api/v1/docs
#   local-stack-07 - React + Azure Function (JWT):
#     - React SPA: http://localhost:3002
#     - API docs: http://localhost:8080/api/v1/docs
#     - JWT: Automatic authentication (demo / password123)
#   local-stack-08 - React + Azure Function (MSAL local):
#     - React SPA: http://localhost:3003
#     - API docs: http://localhost:8080/api/v1/docs
#     - Auth: MSAL (requires Azure AD app registration)
#   local-stack-09 - React + Azure Function (JWT with node server.js):
#     - React SPA: http://localhost:3004
#     - API docs: http://localhost:8080/api/v1/docs
#     - JWT: Runtime config via /runtime-config endpoint (demo / password123)
#     - Simulates Azure Web App deployment with node server.js
#   local-stack-10 - React + Web App proxy -> Azure Function (JWT):
#     - React SPA (proxy): http://localhost:3005
#     - API docs: http://localhost:8080/api/v1/docs
#     - Proxy: Browser hits /api/* via Vite/Express server, which forwards to the Function App
#   local-stack-11 - React + Keycloak OIDC + Azure Function (OAuth2):
#     - React SPA: http://localhost:3006
#     - API docs: http://localhost:8301/api/v1/docs
#     - Keycloak Admin: http://localhost:8300 (admin / admin123)
#     - Auth: OAuth2/OIDC with Keycloak (simulates Azure Entra ID)
#     - Test users: demo / password123, admin / securepass
#   local-stack-12 - React + OAuth2 Proxy + APIM + Keycloak (Easy Auth simulation):
#     - Frontend via OAuth2 Proxy: http://localhost:3007
#     - APIM Simulator: http://localhost:8302
#     - Keycloak Admin: http://localhost:8300 (admin / admin123)
#     - Auth: OAuth2 Proxy forces login upfront (simulates Azure Easy Auth)
#     - Test users: demo / password123
services:
  api-fastapi-azure-function:
    build:
      context: ./api-fastapi-azure-function
      dockerfile: Dockerfile
    platform: linux/amd64
    image: subnet-calculator-api-fastapi-azure-function:latest
    init: true
    ports:
      - "8080:80"
    environment:
      # JWT Authentication with Argon2 hashed passwords
      - AUTH_METHOD=jwt
      - JWT_SECRET_KEY=docker-compose-dev-secret-key-min-32-chars-long-12345
      - JWT_ALGORITHM=HS256
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
      # Argon2 hashed passwords: demo=password123, admin=securepass
      - JWT_TEST_USERS={"demo":"$$argon2id$$v=19$$m=65536,t=3,p=4$$TklhcmEkyMzqJaH3KHQQDA$$rgp8AmtaR6PzBgjyZGNsivb2yJRqULRt5B+BmzUnzbo","admin":"$$argon2id$$v=19$$m=65536,t=3,p=4$$JiTJZlTwD/1jJLlMQMOwCA$$HbubnE11kzEfcszqKtMOmjvxj14vjooqbdZtgc1NYCs"}
      # CORS origins for React frontend on port 3004
      - CORS_ORIGINS=http://localhost:3004
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  frontend-python-flask:
    build:
      context: ./frontend-python-flask
      dockerfile: Dockerfile
    image: subnet-calculator-frontend-python-flask:latest
    ports:
      - "8000:8000"
    environment:
      - API_BASE_URL=http://api-fastapi-azure-function:80/api/v1
      # JWT Authentication credentials
      - JWT_USERNAME=demo
      - JWT_PASSWORD=password123
    depends_on:
      api-fastapi-azure-function:
        condition: service_healthy

  api-fastapi-container-app:
    build:
      context: ./api-fastapi-container-app
      dockerfile: Dockerfile
    platform: linux/amd64
    image: subnet-calculator-api-fastapi-container-app:latest
    ports:
      - "8090:8000"
    environment:
      # No authentication for local development (static frontend doesn't implement JWT)
      # For JWT auth testing, use the standalone api-fastapi-container-app/compose.yml
      - AUTH_METHOD=none
      # CORS origins for all frontends (container and local dev)
      # Container ports: 8001-8004 (static, flask, typescript, react)
      # Local dev ports: 3000-3002 (react/typescript dev), 5000 (flask dev), 5173-5174 (vite dev servers)
      - CORS_ORIGINS=http://localhost:8001,http://localhost:8002,http://localhost:8003,http://localhost:8004,http://localhost:3000,http://localhost:3001,http://localhost:3002,http://localhost:5000,http://localhost:5173,http://localhost:5174
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/health')",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  frontend-html-static:
    build:
      context: ./frontend-html-static
      dockerfile: Dockerfile
    image: subnet-calculator-frontend-html-static:latest
    ports:
      - "8001:80"
    depends_on:
      api-fastapi-container-app:
        condition: service_healthy

  frontend-python-flask-container-app:
    build:
      context: ./frontend-python-flask
      dockerfile: Dockerfile
    image: subnet-calculator-frontend-python-flask:latest
    ports:
      - "8002:8000"
    environment:
      # Connect to Container App API (no JWT auth in compose)
      - API_BASE_URL=http://api-fastapi-container-app:8000/api/v1
      - STACK_NAME=Python Flask + Container App
    depends_on:
      api-fastapi-container-app:
        condition: service_healthy

  frontend-typescript-vite:
    build:
      context: .
      dockerfile: ./frontend-typescript-vite/Dockerfile
      args:
        - VITE_AUTH_ENABLED=false
        - VITE_API_URL=http://localhost:8090
    platform: linux/amd64
    image: subnet-calculator-frontend-typescript-vite:latest
    ports:
      - "8003:80"
    environment:
      # No authentication (default)
      - VITE_AUTH_ENABLED=false
      - VITE_API_URL=http://localhost:8090
    depends_on:
      api-fastapi-container-app:
        condition: service_healthy

  frontend-typescript-vite-jwt:
    build:
      context: .
      dockerfile: ./frontend-typescript-vite/Dockerfile
      args:
        - VITE_AUTH_ENABLED=true
        - VITE_JWT_USERNAME=demo
        - VITE_JWT_PASSWORD=password123
        - VITE_API_URL=http://localhost:8080
    platform: linux/amd64
    image: subnet-calculator-frontend-typescript-vite-jwt:latest
    ports:
      - "3001:80"
    environment:
      - VITE_AUTH_ENABLED=true
      - VITE_JWT_USERNAME=demo
      - VITE_JWT_PASSWORD=password123
      - VITE_API_URL=http://localhost:8080
    depends_on:
      api-fastapi-azure-function:
        condition: service_healthy

  frontend-react:
    build:
      context: .
      dockerfile: ./frontend-react/Dockerfile
      args:
        - VITE_API_URL=http://localhost:8090
        - VITE_AUTH_METHOD=none
    platform: linux/amd64
    image: subnet-calculator-frontend-react:latest
    ports:
      - "8004:80"
    environment:
      - VITE_API_URL=http://localhost:8090
      - VITE_AUTH_METHOD=none
    depends_on:
      api-fastapi-container-app:
        condition: service_healthy

  frontend-react-jwt:
    build:
      context: .
      dockerfile: ./frontend-react/Dockerfile
      args:
        - VITE_API_URL=http://localhost:8080
        - VITE_AUTH_METHOD=jwt
        - VITE_JWT_USERNAME=demo
        - VITE_JWT_PASSWORD=password123
    platform: linux/amd64
    image: subnet-calculator-frontend-react-jwt:latest
    ports:
      - "3002:80"
    environment:
      - VITE_API_URL=http://localhost:8080
      - VITE_AUTH_METHOD=jwt
      - VITE_JWT_USERNAME=demo
      - VITE_JWT_PASSWORD=password123
    depends_on:
      api-fastapi-azure-function:
        condition: service_healthy

  frontend-react-msal:
    build:
      context: .
      dockerfile: ./frontend-react/Dockerfile
      args:
        - VITE_API_URL=http://localhost:8080
        - VITE_AUTH_METHOD=msal
        # Note: MSAL requires Azure AD app registration
        # Set these via environment variables or .env file:
        # - VITE_AZURE_CLIENT_ID=your-client-id
        # - VITE_AZURE_TENANT_ID=your-tenant-id
    platform: linux/amd64
    image: subnet-calculator-frontend-react-msal:latest
    ports:
      - "3003:80"
    environment:
      - VITE_API_URL=http://localhost:8080
      - VITE_AUTH_METHOD=msal
    depends_on:
      api-fastapi-azure-function:
        condition: service_healthy

  frontend-react-server-jwt:
    build:
      context: .
      dockerfile: ./frontend-react/Dockerfile.server
    platform: linux/amd64
    image: subnet-calculator-frontend-react-server-jwt:latest
    ports:
      - "3004:8080"
    environment:
      # Runtime configuration injected via environment variables (like Azure Web App)
      - PORT=8080
      # Use localhost URL for browser access (client appends /api/v1/... paths)
      - API_BASE_URL=http://localhost:8080
      - AUTH_METHOD=jwt
      - JWT_USERNAME=demo
      - JWT_PASSWORD=password123
    depends_on:
      api-fastapi-azure-function:
        condition: service_healthy

  frontend-react-proxy:
    build:
      context: .
      dockerfile: ./frontend-react/Dockerfile.server
    platform: linux/amd64
    image: subnet-calculator-frontend-react-proxy:latest
    ports:
      - "3005:8080"
    environment:
      # Proxy /api/* requests through the Node/Vite host just like the Azure Web App stack
      - PORT=8080
      - API_BASE_URL=
      - API_PROXY_ENABLED=true
      - PROXY_API_URL=http://api-fastapi-azure-function:80
      - PROXY_FORWARD_EASYAUTH_HEADERS=true
      # Enable the Managed Identity code path; token acquisition will fail locally
      # unless the container inherits Azure credentials (expected, logged as warning).
      - PROXY_MANAGED_IDENTITY_ENABLED=true
      - AUTH_METHOD=jwt
      - JWT_USERNAME=demo
      - JWT_PASSWORD=password123
    depends_on:
      api-fastapi-azure-function:
        condition: service_healthy

  # -----------------------------------------------------------------------------
  # Local Stack 11 - Keycloak OAuth2/OIDC Simulation
  # Simulates Azure Entra ID authentication flows locally
  # -----------------------------------------------------------------------------

  keycloak:
    image: quay.io/keycloak/keycloak:26.4.7
    ports:
      - "8300:8080"
    environment:
      # Admin credentials
      - KC_BOOTSTRAP_ADMIN_USERNAME=admin
      - KC_BOOTSTRAP_ADMIN_PASSWORD=admin123
      # Database (dev mode uses H2)
      - KC_DB=dev-file
      # Hostname configuration for local development
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_HTTP_ENABLED=true
      # Health check
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
    command:
      - start-dev
      - --import-realm
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "exec 3<>/dev/tcp/localhost/9000 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200\\|UP'",
        ]
      interval: 10s
      timeout: 5s
      # Keycloak startup can be slow if the user forces emulation (e.g. DOCKER_DEFAULT_PLATFORM=linux/amd64 on arm64).
      retries: 30
      start_period: 240s

  api-fastapi-keycloak:
    build:
      context: ./api-fastapi-azure-function
      dockerfile: Dockerfile
    platform: linux/amd64
    image: subnet-calculator-api-fastapi-keycloak:latest
    init: true
    ports:
      - "8301:80"
    environment:
      # Keycloak OIDC Authentication
      - AUTH_METHOD=oidc
      - OIDC_ISSUER=http://localhost:8300/realms/subnet-calculator
      - OIDC_AUDIENCE=api-app
      - OIDC_JWKS_URI=http://keycloak:8080/realms/subnet-calculator/protocol/openid-connect/certs
      # CORS for React frontends (Stack 11 on :3006, Stack 12 on :3007)
      - CORS_ORIGINS=http://localhost:3006,http://localhost:3007
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      keycloak:
        condition: service_healthy

  frontend-react-keycloak:
    build:
      context: .
      dockerfile: ./frontend-react/Dockerfile
      args:
        - VITE_API_URL=http://localhost:8301
        - VITE_AUTH_METHOD=oidc
        - VITE_OIDC_AUTHORITY=http://localhost:8300/realms/subnet-calculator
        - VITE_OIDC_CLIENT_ID=frontend-app
        - VITE_OIDC_REDIRECT_URI=http://localhost:3006
    platform: linux/amd64
    image: subnet-calculator-frontend-react-keycloak:latest
    ports:
      - "3006:80"
    environment:
      - VITE_API_URL=http://localhost:8301
      - VITE_AUTH_METHOD=oidc
      - VITE_OIDC_AUTHORITY=http://localhost:8300/realms/subnet-calculator
      - VITE_OIDC_CLIENT_ID=frontend-app
      - VITE_OIDC_REDIRECT_URI=http://localhost:3006
    depends_on:
      api-fastapi-keycloak:
        condition: service_healthy
      keycloak:
        condition: service_healthy

  # -----------------------------------------------------------------------------
  # Local Stack 12 - OAuth2 Proxy Sidecar Pattern (Easy Auth Simulation)
  # Demonstrates "forced login upfront" similar to Azure Easy Auth
  # Architecture: User → OAuth2 Proxy :3007 → Frontend Nginx (internal)
  # -----------------------------------------------------------------------------

  # Frontend (not directly exposed - only accessible through OAuth2 Proxy)
  frontend-react-keycloak-protected:
    build:
      context: .
      dockerfile: ./frontend-react/Dockerfile
      args:
        # API calls go directly to APIM simulator on :8302 (proxy mode disabled)
        VITE_API_URL: http://localhost:8302
        VITE_API_PROXY_ENABLED: "false"
        VITE_AUTH_METHOD: "oidc"
        VITE_OIDC_AUTHORITY: "http://localhost:8300/realms/subnet-calculator"
        VITE_OIDC_CLIENT_ID: "frontend-app"
        VITE_OIDC_REDIRECT_URI: "http://localhost:3007"
        VITE_APIM_SUBSCRIPTION_KEY: stack12-demo-key
        VITE_OIDC_AUTO_LOGIN: "true"
    platform: linux/amd64
    image: subnet-calculator-frontend-react-protected:latest
    # No ports exposed - only accessible through oauth2-proxy
    expose:
      - "80"
    environment:
      # API calls go directly to APIM simulator on :8302 (proxy mode disabled)
      VITE_API_URL: http://localhost:8302
      VITE_API_PROXY_ENABLED: "false"
      VITE_AUTH_METHOD: "oidc"
      VITE_OIDC_AUTHORITY: "http://localhost:8300/realms/subnet-calculator"
      VITE_OIDC_CLIENT_ID: "frontend-app"
      VITE_OIDC_REDIRECT_URI: "http://localhost:3007"
      VITE_OIDC_AUTO_LOGIN: "true"
      VITE_APIM_SUBSCRIPTION_KEY: stack12-demo-key
    depends_on:
      api-fastapi-keycloak:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      apim-simulator:
        condition: service_started

  # OAuth2 Proxy - Acts like Azure Easy Auth
  oauth2-proxy-frontend:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.13.0
    platform: linux/amd64
    ports:
      - "3007:4180"
    command:
      # OIDC Provider (Keycloak)
      - --provider=oidc
      - --oidc-issuer-url=http://localhost:8300/realms/subnet-calculator
      - --client-id=frontend-app
      # ---------------------------------------------------------------------------------
      # WARNING: OAuth2 client secret is hardcoded for demonstration purposes only.
      # This configuration is ONLY safe for the OAuth2 Proxy sidecar pattern where the
      # proxy acts as a backend component and is not exposed directly to end users.
      #
      # For public clients (SPAs), do NOT use client secrets as they cannot be kept
      # confidential. Instead, use PKCE (Proof Key for Code Exchange) without a client
      # secret. See: https://oauth.net/2/pkce/
      #
      # For production OAuth2 Proxy deployments, set the client secret via environment
      # variables or a secrets management system (Azure Key Vault, Kubernetes Secrets).
      # ---------------------------------------------------------------------------------
      - --client-secret=frontend-secret
      - --redirect-url=http://localhost:3007/oauth2/callback
      - --code-challenge-method=S256

      # Skip discovery and manually configure endpoints
      - --skip-oidc-discovery=true
      - --login-url=http://localhost:8300/realms/subnet-calculator/protocol/openid-connect/auth
      - --redeem-url=http://keycloak:8080/realms/subnet-calculator/protocol/openid-connect/token
      - --oidc-jwks-url=http://keycloak:8080/realms/subnet-calculator/protocol/openid-connect/certs
      - --validate-url=http://keycloak:8080/realms/subnet-calculator/protocol/openid-connect/userinfo

      # ---------------------------------------------------------------------------------
      # Upstream (frontend only - API traffic now flows through apim-simulator:8302)
      #
      # OAuth2 Proxy protects access to the static assets and injects user headers.
      # The React SPA then talks directly to the APIM simulator on port 8302.
      #
      # ROUTING BEHAVIOR:
      # - All browser requests → Routed to frontend-react-keycloak-protected:80
      # - API requests → Sent from the SPA to http://localhost:8302 (APIM simulator)
      #
      # This mirrors the Azure pattern of having Easy Auth in front of the frontend
      # while Application Gateway/API Management sit in front of the backend APIs.
      # ---------------------------------------------------------------------------------
      - --upstream=http://frontend-react-keycloak-protected:80

      # Listen address
      - --http-address=0.0.0.0:4180

      # Cookie configuration
      # ---------------------------------------------------------------------------------
      # WARNING: The cookie secret below is hardcoded for demonstration purposes only.
      # For production, generate a strong secret and set it via environment variables
      # or a secrets management system. Generate a new secret with:
      #   python -c 'import secrets; print(secrets.token_urlsafe(32))'
      # ---------------------------------------------------------------------------------
      - --cookie-secret=OQINaROshtE9TcZkNAm-5Zs2pZWWyqhBcfyqGMC5H0A=
      - --cookie-secure=false
      - --cookie-httponly=true
      - --cookie-expire=4h
      - --cookie-refresh=1h
      - --cookie-name=_oauth2_proxy

      # Email domain (allow all)
      - --email-domain=*

      # Scopes (only request scopes that exist in Keycloak realm)
      - --scope=openid user_impersonation

      # Pass headers to upstream
      - --pass-authorization-header=true
      - --pass-access-token=true
      - --pass-user-headers=true
      - --set-authorization-header=true
      - --set-xauthrequest=true

      # Logging
      - --standard-logging=true
      - --auth-logging=true
      - --request-logging=true

    depends_on:
      frontend-react-keycloak-protected:
        condition: service_started
      keycloak:
        condition: service_healthy

  # API Management simulator - validates tokens then forwards to the FastAPI backend
  apim-simulator:
    build:
      context: ./api-apim-simulator
      dockerfile: Dockerfile
    platform: linux/amd64
    image: subnet-calculator-apim-simulator:latest
    ports:
      - "8302:8000"
    environment:
      - BACKEND_BASE_URL=http://api-fastapi-keycloak:80
      - OIDC_ISSUER=http://localhost:8300/realms/subnet-calculator
      - OIDC_AUDIENCE=api-app
      - OIDC_JWKS_URI=http://keycloak:8080/realms/subnet-calculator/protocol/openid-connect/certs
      - APIM_SUBSCRIPTION_KEY=stack12-demo-key
      - ALLOWED_ORIGINS=http://localhost:3007
    depends_on:
      api-fastapi-keycloak:
        condition: service_healthy
      keycloak:
        condition: service_healthy
