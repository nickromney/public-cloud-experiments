# GitHub Actions Workflows

Security and quality checks for this Terraform/Terragrunt repository.

## Workflows

### 1. Secret Scanning (`secret-scanning.yml`)

Runs on every push and pull request to detect accidentally committed secrets.

**Tools:**

- **Gitleaks**: Fast, comprehensive secret scanner
- **TruffleHog**: Verified secrets detection

**Custom patterns detected:**

- Azure Subscription IDs
- Azure Tenant IDs
- Pluralsight sandbox resource group names
- Azure storage account names with timestamps
- Azure Service Principal client secrets

### 2. Terraform Security (`terraform-security.yml`)

Infrastructure security and quality checks.

**Tools:**

- **tfsec**: Static analysis for Terraform security issues
- **tflint**: Terraform linting for best practices
- **terraform fmt**: Code formatting validation

**Checks:**

- Security misconfigurations (public storage, weak encryption, etc.)
- Azure-specific security rules
- Code formatting consistency
- Best practices compliance

## Local Setup

Install pre-commit hooks for local scanning before you commit:

```bash
# Install pre-commit
brew install pre-commit

# Install git hooks
pre-commit install

# Run manually on all files
pre-commit run --all-files
```

## Configuration Files

- `.gitleaks.toml` - Custom secret detection patterns
- `.pre-commit-config.yaml` - Local pre-commit hook configuration
- `.tflint.hcl` - TFLint configuration (auto-generated by Makefile)

## What Gets Scanned

**Scanned:**

- All `.tf`, `.hcl`, `.tfvars`, `.sh` files
- GitHub Actions workflow files

**Excluded:**

- `.terraform/` directories
- `.terragrunt-cache/` directories
- `*.tfvars.example` files (placeholders only)
- Binary files and lock files

## Handling False Positives

If a legitimate value is flagged, you can:

1. **Add to `.gitleaks.toml` allowlist**:

   ```toml
   [[rules.allowlist]]
   paths = ['''path/to/file\.tf$''']
   ```

2. **Use inline comments**:

   ```hcl
   # gitleaks:allow
   subscription_id = "00000000-0000-0000-0000-000000000000"
   ```

## Security Best Practices

1. **Never commit**:

   - Actual subscription IDs, tenant IDs
   - Service Principal credentials
   - Storage account names from real environments
   - Resource group names from real environments

2. **Always use**:

   - Environment variables (`get_env()` in Terragrunt)
   - Git-ignored files (`.tfvars`, `state.tf`, `backend.tf`)
   - Example files with placeholders (`.tfvars.example`)

3. **Before pushing**:

   ```bash
   # Run all checks locally
   make quality        # Format check + lint
   pre-commit run -a   # All pre-commit hooks
   ```

## If Secrets Are Detected

1. **Rotate immediately**: If real credentials leaked, rotate them in Azure portal
2. **Remove from history**: Use `git filter-repo` or BFG Repo-Cleaner
3. **Force push**: After cleaning history, force push (coordinate with team)
4. **Verify**: Run full scan with `gitleaks detect --verbose`
